<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aegis Protocol ‚Äî AEGIS:HQ</title>
  <style>
    :root { --bg:#0b0f14; --bg-alt:#0e131a; --panel:#121821; --text:#d7e2f0; --muted:#8aa0b6; --accent:#2cc1ff; --accent-2:#ff3b3b; --accent-3:#33e1a2; --border:#1f2a36; }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg-alt));color:var(--text);font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .header{display:grid;grid-template-columns:1fr auto auto;gap:1rem;align-items:center;padding:1rem 1.5rem;border-bottom:1px solid var(--border);background:rgba(10,14,20,.85);backdrop-filter:blur(6px);position:sticky;top:0;z-index:50}
    .brand{display:flex;align-items:center;gap:1rem}.brand-text h1{margin:0;font-size:1.3rem;letter-spacing:.6px}.motto{margin:0;font-size:.8rem;color:var(--muted)}
    .logo{position:relative;width:40px;height:40px}
    .logo-core{position:absolute;inset:10px;border-radius:50%;background:#3aa6ff;box-shadow:0 0 12px #22b0ff inset}
    .logo-arc{position:absolute;left:8px;right:8px;top:14px;height:6px;border-radius:6px;background:#ff2f2f}
    .logo-point{position:absolute;width:8px;height:18px;background:#2a3442}.logo-point.top{top:0;left:calc(50% - 4px)}.logo-point.bottom{bottom:0;left:calc(50% - 4px)}.logo-point.left{left:0;top:calc(50% - 9px)}.logo-point.right{right:0;top:calc(50% - 9px)}
    .nav{display:flex;gap:.5rem}.nav-link{background:transparent;color:var(--text);border:1px solid var(--border);padding:.5rem .8rem;border-radius:8px;cursor:pointer}.nav-link:hover{border-color:var(--accent);color:var(--accent)}.nav-link.active{background:#09121b;border-color:var(--accent);color:var(--accent)}
    .profile{display:flex;align-items:center;gap:.6rem}.avatar{width:32px;height:32px;border-radius:50%;background:#223042;display:flex;align-items:center;justify-content:center;color:#9ec9ff;font-weight:600}
    .logout{background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:.3rem .6rem;cursor:pointer}.logout:hover{color:#ff7d7d;border-color:#ff7d7d}
    .main{padding:1.2rem}.route{display:none}.route.visible{display:block}
    .grid{display:grid;gap:1rem}
    .grid-home{grid-template-columns:2fr 1fr;grid-template-areas:"welcome tiles" "surveillance divisions" "intel-map divisions" "mission-log mission-log"}
    .welcome{grid-area:welcome}.tiles{grid-area:tiles}.surveillance{grid-area:surveillance}.divisions{grid-area:divisions;display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}.intel-map{grid-area:intel-map}.mission-log{grid-area:mission-log}
    .grid-two{grid-template-columns:1fr 1fr}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:1rem;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .panel-header{display:flex;align-items:center;justify-content:space-between;gap:1rem}.controls{display:flex;align-items:center;gap:.6rem}
    .tiles .tile{display:flex;gap:.8rem;align-items:center;background:#0f1722;border:1px solid var(--border);padding:.8rem;border-radius:10px;cursor:pointer}.tiles .tile:hover{border-color:var(--accent);color:var(--accent)}
    .select,input,button,input[type="search"],select{background:#0b121b;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:.5rem .6rem}
    .btn{cursor:pointer;transition:border-color .15s,color .15s}.btn:hover{border-color:var(--accent);color:var(--accent)}.btn.primary{border-color:var(--accent);color:var(--accent)}.btn.danger{border-color:var(--accent-2);color:var(--accent-2)}
    .status-badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:.8rem}.status-active{color:var(--accent-3);border-color:var(--accent-3)}
    .tally{display:flex;flex-direction:column;align-items:center;justify-content:center}.tally-number{font-size:2rem;color:var(--accent)}.tally-label{color:var(--muted)}
    .list{list-style:none;padding:0;margin:0}.list li{display:flex;justify-content:space-between;gap:1rem;padding:.6rem;border-bottom:1px solid var(--border)}
    .cards{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.8rem}.cards li{background:#0f1722;border:1px solid var(--border);border-radius:10px;padding:.8rem}
    .surveillance-content{display:grid;grid-template-columns:2fr 1fr;gap:1rem;align-items:start}
    #video{width:100%;height:100%;background:#0a0f16;border-radius:10px;border:1px solid var(--border)}
    #snapshotCanvas{width:100%;background:#0a0f16;border-radius:10px;border:1px solid var(--border)}
    #map{width:100%;height:320px;border:1px solid var(--border);border-radius:10px}
    .auth{display:flex;gap:1rem;margin-top:.5rem}.auth input{width:12rem}
    .footer{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1.2rem;border-top:1px solid var(--border);color:var(--muted)}
    @media (max-width:1000px){.grid-home{grid-template-columns:1fr;grid-template-areas:"welcome" "tiles" "surveillance" "intel-map" "divisions" "mission-log"} .divisions{grid-template-columns:1fr 1fr} .surveillance-content{grid-template-columns:1fr}}
  </style>
  <script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <header class="header">
  <div class="brand">
    <!-- Emblem embedded here -->
    <img src="assets/emblem.png" alt="Aegis Protocol Emblem" 
         style="width:40px;height:40px;border-radius:8px;" />
    <div class="brand-text">
      <h1>Aegis Protocol</h1>
      <p class="motto">We see what others miss.</p>
    </div>
  </div>
      <div class="logo">
        <span class="logo-core"></span><span class="logo-arc"></span>
        <span class="logo-point top"></span><span class="logo-point right"></span>
        <span class="logo-point bottom"></span><span class="logo-point left"></span>
      </div>
      <div class="brand-text">
        <h1>Aegis Protocol</h1><p class="motto">We see what others miss.</p>
      </div>
    </div>
    <nav class="nav">
      <button class="nav-link active" data-route="login">Login</button>
      <button class="nav-link" data-route="home">Dashboard</button>
      <button class="nav-link" data-route="operations">Operations</button>
      <button class="nav-link" data-route="intel">Intel Feed</button>
      <button class="nav-link" data-route="agents">Agents</button>
      <button class="nav-link" data-route="vault">Secure Vault</button>
      <button class="nav-link" data-route="settings">Settings</button>
    </nav>
    <div class="profile">
      <div class="avatar">AP</div>
      <div class="profile-meta">
        <span class="name" id="sessionUser">Guest</span>
        <button class="logout" id="logoutBtn">Log out</button>
      </div>
    </div>
  </header>

  <main class="main">
    <!-- LOGIN -->
    <section id="login" class="route visible">
      <div class="grid grid-two">
        <div class="panel">
          <h2>Admin login</h2>
          <div class="auth">
            <input id="adminCodename" placeholder="Codename" value="admin" />
            <input id="adminPassword" type="password" placeholder="Password" value="admin" />
            <button class="btn primary" id="adminLoginBtn">Login</button>
          </div>
          <p class="motto">Default admin is pre-seeded for first run.</p>
        </div>
        <div class="panel">
          <h2>Agent login</h2>
          <div class="auth">
            <input id="agentCodename" placeholder="Codename" />
            <input id="agentPassword" type="password" placeholder="Password" />
            <button class="btn primary" id="agentLoginBtn">Login + Face</button>
          </div>
          <div style="margin-top:1rem;">
            <video id="loginVideo" autoplay playsinline style="width:100%; border:1px solid var(--border); border-radius:10px;"></video>
            <span id="loginStatus" class="status-badge">Idle</span>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:1rem;">
        <h2>Admin panel</h2>
        <div class="auth" style="flex-wrap:wrap;">
          <input id="newCode" placeholder="Codename" />
          <input id="newClearance" placeholder="Clearance (Alpha/Omega/Sigma)" />
          <input id="newPassword" type="password" placeholder="Password" />
          <button class="btn" id="captureFaceBtn">Capture face</button>
          <button class="btn primary" id="saveAgentBtn">Save agent</button>
          <span id="adminStatus" class="status-badge">Awaiting input</span>
        </div>
        <video id="adminVideo" autoplay playsinline style="margin-top:1rem; width:100%; border:1px solid var(--border); border-radius:10px;"></video>
        <ul id="agentList" class="list" style="margin-top:1rem;"></ul>
      </div>
    </section>

    <!-- HOME -->
    <section id="home" class="route">
      <div class="grid grid-home">
        <div class="panel welcome">
          <h2>Welcome, <span id="welcomeUser">Agent</span></h2>
          <div class="meta">
            <div><strong>Status:</strong> <span class="status-badge status-active" id="sessionStatus">Active</span></div>
            <div><strong>Last login:</strong> <span id="lastLogin"></span></div>
          </div>
        </div>

        <div class="panel tiles">
          <div class="tile" data-route="home" data-anchor="surveillance">
            <div class="tile-icon">üé•</div>
            <div class="tile-text"><h3>Live Surveillance</h3><p>Real-time feeds from connected cameras</p></div>
          </div>
          <div class="tile" data-route="intel">
            <div class="tile-icon">üß†</div>
            <div class="tile-text"><h3>Intel Feed</h3><p>Threats and predictions</p></div>
          </div>
          <div class="tile" data-route="agents">
            <div class="tile-icon">üßë‚Äçüíª</div>
            <div class="tile-text"><h3>Agents</h3><p>Directory and metrics</p></div>
          </div>
          <div class="tile" data-route="settings">
            <div class="tile-icon">üõ°Ô∏è</div>
            <div class="tile-text"><h3>Security Protocols</h3><p>System health and alerts</p></div>
          </div>
        </div>

        <!-- Live Surveillance -->
        <div class="panel surveillance" id="surveillance">
          <div class="panel-header">
            <h2>Live Surveillance</h2>
            <div class="controls">
              <label for="cameraSelect">Camera:</label>
              <select id="cameraSelect" class="select"></select>
              <button id="startCamera" class="btn primary">Start</button>
              <button id="stopCamera" class="btn">Stop</button>
              <button id="snapshot" class="btn">Snapshot</button>
            </div>
          </div>
          <div class="surveillance-content">
            <video id="video" autoplay playsinline></video>
            <canvas id="snapshotCanvas" width="640" height="360"></canvas>
            <div class="surveillance-footer">
              <span id="cameraStatus" class="status-badge">Idle</span>
              <span id="recognitionStatus" class="status-badge">Recognition idle</span>
            </div>
          </div>
        </div>

        <!-- Intel Map with live location -->
        <div class="panel intel-map">
          <div class="panel-header"><h2>Live location map</h2></div>
          <div id="map"></div>
          <div style="margin-top:.6rem;"><span class="status-badge" id="mapStatus">Map ready</span></div>
        </div>

        <!-- Division panels -->
        <div class="panel divisions">
          <div class="division"><h3>Spectral Ops</h3><p>Field agents specializing in infiltration, extraction, and counterintelligence.</p><button class="btn">Current Missions</button></div>
          <div class="division"><h3>EchoNet</h3><p>Digital surveillance, signal interception, and AI-driven threat analysis.</p><button class="btn">View Analysis</button></div>
          <div class="division"><h3>Obsidian Vault</h3><p>Secure data repository and black site operations hub.</p><button class="btn">Access Files</button></div>
          <div class="division tally"><div class="tally-number" id="agentsOnline">47</div><div class="tally-label">Agents Online</div></div>
        </div>

        <!-- Mission Log -->
        <div class="panel mission-log">
          <div class="panel-header"><h2>Mission Log</h2><input type="search" id="missionSearch" placeholder="Search directives‚Ä¶" /></div>
          <ul id="missionList" class="list"></ul>
        </div>
      </div>
    </section>

    <!-- OPERATIONS -->
    <section id="operations" class="route">
      <div class="grid grid-two">
        <div class="panel"><h2>Mission Tracker</h2><ul id="missionTracker" class="list"></ul></div>
        <div class="panel"><h2>Assignment Board</h2><ul id="assignmentBoard" class="list"></ul></div>
        <div class="panel"><h2>Field Reports</h2><ul id="fieldReports" class="list"></ul></div>
      </div>
    </section>

    <!-- INTEL FEED -->
    <section id="intel" class="route">
      <div class="grid grid-two">
        <div class="panel"><h2>Threat Map</h2><div class="globe-placeholder" style="height:240px;border:1px dashed var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--muted)">Interactive globe placeholder</div></div>
        <div class="panel"><h2>Intercept Logs</h2><ul id="interceptLogs" class="list"></ul></div>
        <div class="panel"><h2>AI Predictions</h2><ul id="aiPredictions" class="list"></ul></div>
      </div>
    </section>

    <!-- AGENTS -->
    <section id="agents" class="route">
      <div class="grid grid-two">
        <div class="panel"><h2>Agent Directory</h2><ul id="agentDirectory" class="cards"></ul></div>
        <div class="panel"><h2>Performance Metrics</h2><ul id="performanceMetrics" class="list"></ul></div>
        <div class="panel"><h2>Secure Messaging</h2>
          <div class="messaging"><ul id="messages" class="list"></ul>
            <div class="compose"><input id="messageInput" placeholder="Type encrypted message‚Ä¶" /><button id="sendMessage" class="btn primary">Send</button></div>
          </div>
        </div>
      </div>
    </section>

    <!-- SECURE VAULT -->
    <section id="vault" class="route">
      <div class="grid grid-two">
        <div class="panel"><h2>Encrypted Archives</h2><ul id="archives" class="list"></ul></div>
        <div class="panel"><h2>Access Logs</h2><ul id="accessLogs" class="list"></ul></div>
        <div class="panel"><h2>Emergency Lockdown</h2><p>Trigger a manual override and system purge.</p><button id="lockdown" class="btn danger">Initiate Lockdown</button><span id="lockdownStatus" class="status-badge">Standby</span></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="route">
      <div class="grid grid-two">
        <div class="panel">
          <h2>Profile Management</h2>
          <form id="profileForm" class="form">
            <label>Codename<input name="codename" value="Aegis-47" /></label>
            <label>Clearance Level<select name="clearance"><option>Alpha</option><option selected>Omega</option><option>Sigma</option></select></label>
            <label>Biometrics<input name="biometrics" placeholder="Registered" /></label>
            <button class="btn primary" type="submit">Save</button>
          </form>
        </div>
        <div class="panel"><h2>Theme</h2>
          <div class="theme-toggle">
            <button class="btn" data-theme="dark">Dark</button>
            <button class="btn" data-theme="light">Light</button>
            <button class="btn" data-theme="stealth">Stealth</button>
          </div>
        </div>
        <div class="panel"><h2>Security Settings</h2>
          <ul class="list"><li><strong>MFA:</strong> Enabled</li><li><strong>Device Trust:</strong> This device trusted</li><li><strong>Access Zones:</strong> HQ, Field</li></ul>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer"><span>AEGIS:HQ ¬© Aegis Protocol</span><span>Build v1.0</span></footer>

  <script>
    // SPA navigation and session
    const routes = Array.from(document.querySelectorAll(".route"));
    const navLinks = Array.from(document.querySelectorAll(".nav-link"));
    const sessionUserEl = document.getElementById("sessionUser");
    const welcomeUserEl = document.getElementById("welcomeUser");
    const lastLoginEl = document.getElementById("lastLogin");
    const logoutBtn = document.getElementById("logoutBtn");
    let sessionUser = null;

    navLinks.forEach(btn => {
      btn.addEventListener("click", () => {
        const route = btn.dataset.route;
        navLinks.forEach(b => b.classList.toggle("active", b === btn));
        routes.forEach(r => r.classList.toggle("visible", r.id === route));
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });

    function setSession(user) {
      sessionUser = user;
      sessionUserEl.textContent = user || "Guest";
      welcomeUserEl.textContent = user || "Agent";
      lastLoginEl.textContent = new Date().toLocaleString();
      document.querySelector('.nav-link[data-route="home"]')?.click();
    }
    logoutBtn.addEventListener("click", () => setSession(null));

    // DB helpers and seed admin
    function getDB() { return JSON.parse(localStorage.getItem("aegis_db") || "{}"); }
    function setDB(db) { localStorage.setItem("aegis_db", JSON.stringify(db)); }
    function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h|=0 } return String(h) }

    (function seedAdmin(){
      const db = getDB();
      if (!db.admin) {
        db.admin = { codename:"admin", passHash:hash("admin"), role:"admin" };
        db.agents = db.agents || {};
        db.logs = db.logs || [];
        setDB(db);
      }
    })();

    // Admin auth
    const adminCodenameEl = document.getElementById("adminCodename");
    const adminPasswordEl = document.getElementById("adminPassword");
    document.getElementById("adminLoginBtn").addEventListener("click", () => {
      const db = getDB();
      const admin = db.admin;
      if (admin && admin.codename === adminCodenameEl.value && admin.passHash === hash(adminPasswordEl.value)) {
        setSession("admin");
      } else { alert("Admin login failed"); }
    });

    // Admin panel: capture face and save agent
    const adminVideo = document.getElementById("adminVideo");
    const adminStatus = document.getElementById("adminStatus");
    const captureFaceBtn = document.getElementById("captureFaceBtn");
    const saveAgentBtn = document.getElementById("saveAgentBtn");
    const newCodeEl = document.getElementById("newCode");
    const newClearanceEl = document.getElementById("newClearance");
    const newPasswordEl = document.getElementById("newPassword");
    const agentListEl = document.getElementById("agentList");

    // Agent login
    const agentCodenameEl = document.getElementById("agentCodename");
    const agentPasswordEl = document.getElementById("agentPassword");
    const agentLoginBtn = document.getElementById("agentLoginBtn");
    const loginVideo = document.getElementById("loginVideo");
    const loginStatus = document.getElementById("loginStatus");

    // Surveillance
    const cameraSelect = document.getElementById("cameraSelect");
    const startBtn = document.getElementById("startCamera");
    const stopBtn = document.getElementById("stopCamera");
    const snapshotBtn = document.getElementById("snapshot");
    const videoEl = document.getElementById("video");
    const canvasEl = document.getElementById("snapshotCanvas");
    const cameraStatus = document.getElementById("cameraStatus");
    const recognitionStatus = document.getElementById("recognitionStatus");

    // Map
    let map, mapMarker;
    const mapStatus = document.getElementById("mapStatus");
    function initMap(){
      map = L.map('map').setView([12.733, 80.173], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(map);
      mapMarker = L.marker([12.733, 80.173]).addTo(map).bindPopup('No agent selected');
    }
    function updateAgentLocation(name){
      const base=[12.733,80.173], jitter=[base[0]+(Math.random()-0.5)/100, base[1]+(Math.random()-0.5)/100];
      mapMarker.setLatLng(jitter);
      mapMarker.bindPopup(`${name} ‚Äî live position (simulated)`).openPopup();
      mapStatus.textContent = `Tracking: ${name}`;
    }

    async function listCameras(){
      try{
        await navigator.mediaDevices.getUserMedia({ video:true, audio:false }).catch(()=>{});
        const devices = await navigator.mediaDevices.enumerateDevices();
        const inputs = devices.filter(d=>d.kind==="videoinput");
        cameraSelect.innerHTML = "";
        inputs.forEach((d,i)=> {
          const o=document.createElement("option");
          o.value=d.deviceId; o.textContent=d.label || `Camera ${i+1}`;
          cameraSelect.appendChild(o);
        });
        cameraStatus.textContent = inputs.length ? "Cameras detected" : "No cameras found";
      }catch(e){ cameraStatus.textContent = "Camera listing unavailable"; }
    }
    async function startCamera(targetVideo, deviceId){
      try{
        const constraints={ video: deviceId ? { deviceId:{ exact:deviceId } } : { facingMode:"user" }, audio:false };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        targetVideo.srcObject = stream;
        cameraStatus.textContent = "Live"; cameraStatus.classList.add("status-active");
        return stream;
      }catch(e){ cameraStatus.textContent="Unable to start camera"; cameraStatus.classList.remove("status-active"); return null; }
    }
    function stopStream(video){ const s=video.srcObject; if (s) s.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
    snapshotBtn.addEventListener("click", () => {
      const ctx = canvasEl.getContext("2d"); const w=canvasEl.width, h=canvasEl.height; ctx.drawImage(videoEl, 0, 0, w, h);
    });

    function populateLists(){
      const missionList=document.getElementById("missionList");
      ["[REDACTED]‚ÄîNode ‚ñà‚ñà","Directive: Aziem Echo","Recon: Latour","Asset: Harlan"].forEach((name,i)=>{
        const li=document.createElement("li"); li.innerHTML = `<span>${name}</span><span>${(18+i)}:00 IST</span>`; missionList.appendChild(li);
      });
      document.getElementById("missionSearch").addEventListener("input", e=>{
        const q=e.target.value.toLowerCase(); Array.from(missionList.children).forEach(li=> li.style.display = li.textContent.toLowerCase().includes(q) ? "" : "none");
      });

      const missionTracker=document.getElementById("missionTracker");
      ["OP-231: Spectral Insert","OP-198: Perimeter Sweep","OP-177: Silent Relay"].forEach(m=>{
        const li=document.createElement("li"); li.innerHTML = `<span>${m}</span><span class="status-badge status-active">Active</span>`; missionTracker.appendChild(li);
      });
      const assignmentBoard=document.getElementById("assignmentBoard");
      ["Brief‚ÄîEchoNet Backtrace","Task‚ÄîObsidian Integrity Audit","Recon‚ÄîBorder Node Scan"].forEach(m=>{
        const li=document.createElement("li"); li.innerHTML = `<span>${m}</span><span class="status-badge">ETA 12h</span>`; assignmentBoard.appendChild(li);
      });
      const fieldReports=document.getElementById("fieldReports");
      ["Report‚ÄîHarlan/Delta","Report‚ÄîLatour/Beta","Report‚ÄîAziem/Gamma"].forEach(m=>{
        const li=document.createElement("li"); li.innerHTML = `<span>${m}</span><button class="btn">Open</button>`; fieldReports.appendChild(li);
      });
      const interceptLogs=document.getElementById("interceptLogs");
      ["SIGINT‚ÄîChannel 7","COMINT‚ÄîNode C","ELINT‚ÄîSweep Œî"].forEach(m=>{
        const li=document.createElement("li"); li.innerHTML = `<span>${m}</span><button class="btn">Transcript</button>`; interceptLogs.appendChild(li);
      });
      const aiPredictions=document.getElementById("aiPredictions");
      ["Risk‚ÄîSector East: Medium","Risk‚ÄîHarbor Grid: High","Risk‚ÄîUplink Ring: Low"].forEach(m=>{
        const li=document.createElement("li"); li.innerHTML = `<span>${m}</span><button class="btn">Details</button>`; aiPredictions.appendChild(li);
      });

      const agentDirectory=document.getElementById("agentDirectory");
      const db=getDB(); Object.values(db.agents||{}).forEach(a=>{
        const li=document.createElement("li"); li.innerHTML = `<div><strong>${a.codename}</strong></div><div><strong>Clearance:</strong> ${a.clearance}</div><div><strong>Status:</strong> Active</div>`;
        agentDirectory.appendChild(li);
      });

      const performanceMetrics=document.getElementById("performanceMetrics");
      [["Specter-01","Success 96%"],["Wraith-22","Success 89%"],["Ghost-15","Success 92%"],["Cipher-07","Success 87%"]].forEach(([n,m])=>{
        const li=document.createElement("li"); li.innerHTML = `<span>${n}</span><span>${m}</span>`; performanceMetrics.appendChild(li);
      });

      const messages=document.getElementById("messages"); const messageInput=document.getElementById("messageInput");
      document.getElementById("sendMessage").addEventListener("click", ()=>{
        if (!messageInput.value.trim()) return;
        const li=document.createElement("li"); li.innerHTML = `<span>Outbound (Encrypted)</span><span>${messageInput.value}</span>`; messages.prepend(li); messageInput.value="";
      });

      const archives=document.getElementById("archives");
      ["Blueprint‚ÄîNode ‚ñà‚ñà‚ñà","Protocol‚ÄîOmega Layer","Key‚ÄîObsidian Vault"].forEach(a=>{
        const li=document.createElement("li"); li.innerHTML = `<span>${a}</span><button class="btn">Decrypt</button>`; archives.appendChild(li);
      });
      const accessLogs=document.getElementById("accessLogs");
      ["Redmond‚ÄîVault Read","Ghost-15‚ÄîArchive Write","Wraith-22‚ÄîLockdown Test"].forEach(a=>{
        const li=document.createElement("li"); li.innerHTML = `<span>${a}</span><span>${new Date().toLocaleTimeString()}</span>`; accessLogs.appendChild(li);
      });
      const lockdownBtn=document.getElementById("lockdown"); const lockdownStatus=document.getElementById("lockdownStatus");
      lockdownBtn.addEventListener("click", ()=>{ lockdownStatus.textContent="Lockdown initiated"; lockdownStatus.classList.add("status-active"); });
    }

    // face-api.js loading and helpers
    let modelsLoaded=false;
    async function loadModels(){
      const MODEL_URL='https://unpkg.com/face-api.js@0.22.2/weights';
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
      await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
      await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
      modelsLoaded=true;
    }
    async function captureEmbedding(video){
      if (!modelsLoaded) return null;
      const opts=new faceapi.TinyFaceDetectorOptions({ inputSize:256, scoreThreshold:0.5 });
      const det=await faceapi.detectSingleFace(video,opts).withFaceLandmarks().withFaceDescriptor();
      return det?.descriptor || null;
    }
    function embeddingsMatch(a,b,threshold=0.6){
      if (!a||!b||a.length!==b.length) return false;
      let sum=0; for(let i=0;i<a.length;i++){ const d=a[i]-b[i]; sum+=d*d; } return Math.sqrt(sum) < threshold;
    }

    // Save agent
    function renderAgentList(){
      const db=getDB(); agentListEl.innerHTML="";
      Object.values(db.agents||{}).forEach(a=>{
        const li=document.createElement("li"); li.innerHTML = `<span>${a.codename}</span><span>Clearance: ${a.clearance}</span><button class="btn">Remove</button>`;
        li.querySelector("button").addEventListener("click",()=>{ const db2=getDB(); delete db2.agents[a.codename]; setDB(db2); renderAgentList(); });
        agentListEl.appendChild(li);
      });
    }
    renderAgentList();

    captureFaceBtn.addEventListener("click", async () => {
      if (!adminVideo.srcObject) await startCamera(adminVideo, null);
      if (!modelsLoaded){ adminStatus.textContent="Loading models‚Ä¶"; await loadModels(); }
      adminStatus.textContent="Scanning‚Ä¶";
      const emb=await captureEmbedding(adminVideo);
      if (emb){ adminVideo._lastEmbedding=emb; adminStatus.textContent="Face captured"; }
      else { adminStatus.textContent="No face detected"; }
    });

    saveAgentBtn.addEventListener("click", ()=>{
      const code=newCodeEl.value.trim(); const clearance=newClearanceEl.value.trim()||"Omega"; const pass=newPasswordEl.value;
      if (!code||!pass){ adminStatus.textContent="Codename and password required"; return; }
      const db=getDB(); db.agents=db.agents||{};
      if (db.agents[code]){ adminStatus.textContent="Agent exists"; return; }
      const embedding=adminVideo._lastEmbedding||null;
      if (!embedding){ adminStatus.textContent="Capture face first"; return; }
      db.agents[code]={ codename:code, clearance, passHash:hash(pass), embedding:Array.from(embedding), lastLocation:[12.733,80.173] };
      setDB(db); adminStatus.textContent=`Saved ${code}`; renderAgentList();
    });

    // Agent login: password + face
    agentLoginBtn.addEventListener("click", async ()=>{
      const code=agentCodenameEl.value.trim(); const pass=agentPasswordEl.value;
      const db=getDB(); const agent=db.agents?.[code];
      if (!agent || agent.passHash !== hash(pass)){ loginStatus.textContent="Password invalid"; return; }
      if (!loginVideo.srcObject) await startCamera(loginVideo, null);
      if (!modelsLoaded){ loginStatus.textContent="Loading models‚Ä¶"; await loadModels(); }
      loginStatus.textContent="Scanning face‚Ä¶";
      const emb=await captureEmbedding(loginVideo);
      if (!emb){ loginStatus.textContent="No face detected"; return; }
      const match=embeddingsMatch(emb, Float32Array.from(agent.embedding));
      if (match){ loginStatus.textContent="Face match: access granted"; setSession(code); updateAgentLocation(code); }
      else { loginStatus.textContent="Face mismatch: access denied"; }
    });

    // Surveillance recognition loop
    let recognitionLoop=null;
    document.getElementById("startCamera").addEventListener("click", async ()=>{
      await listCameras();
      const deviceId=cameraSelect.value||null;
      await startCamera(videoEl, deviceId);
      if (!modelsLoaded){ recognitionStatus.textContent="Loading models‚Ä¶"; await loadModels(); }
      recognitionStatus.textContent="Recognizing‚Ä¶"; startRecognitionLoop();
    });
    document.getElementById("stopCamera").addEventListener("click", ()=>{
      stopStream(videoEl); stopRecognitionLoop(); cameraStatus.textContent="Stopped"; recognitionStatus.textContent="Recognition idle";
    });

    async function recognitionStep(){
      const db=getDB(); const agents=Object.values(db.agents||{}); if (!agents.length){ recognitionStatus.textContent="No enrolled agents"; return; }
      const emb=await captureEmbedding(videoEl); if (!emb){ recognitionStatus.textContent="No face"; return; }
      let recognized=null;
      for (const a of agents){ if (embeddingsMatch(emb, Float32Array.from(a.embedding))){ recognized=a; break; } }
      if (recognized){ recognitionStatus.textContent=`Recognized: ${recognized.codename}`; updateAgentLocation(recognized.codename); }
      else {
        recognitionStatus.textContent="Unknown face ‚Äî alert";
        recognitionStatus.classList.add("status-active");
        const db2=getDB(); db2.logs=db2.logs||[]; db2.logs.push({ type:"unknown-face", time:Date.now() }); setDB(db2);
      }
    }
    function startRecognitionLoop(){ stopRecognitionLoop(); recognitionLoop=setInterval(recognitionStep, 1500); }
    function stopRecognitionLoop(){ if (recognitionLoop){ clearInterval(recognitionLoop); recognitionLoop=null; } }

    // Initialize
    (async function init(){
      populateLists(); initMap(); await listCameras();
      await startCamera(loginVideo, null); await startCamera(adminVideo, null);
      document.getElementById("sessionStatus").textContent="Active";
    })();

    // Theme
    document.querySelectorAll(".theme-toggle .btn").forEach(b=>{
      b.addEventListener("click", ()=>{
        const theme=b.dataset.theme; const root=document.documentElement.style;
        if (theme==="light"){
          root.setProperty("--bg","#f6f8fb"); root.setProperty("--bg-alt","#ffffff"); root.setProperty("--panel","#ffffff"); root.setProperty("--text","#0e1726"); root.setProperty("--muted","#5b6b7f"); root.setProperty("--border","#e2e8f0");
        } else if (theme==="stealth"){
          root.setProperty("--bg","#000000"); root.setProperty("--bg-alt","#000000"); root.setProperty("--panel","#050505"); root.setProperty("--text","#9bdcff"); root.setProperty("--muted","#6a7a88"); root.setProperty("--border","#111111");
        } else {
          root.setProperty("--bg","#0b0f14"); root.setProperty("--bg-alt","#0e131a"); root.setProperty("--panel","#121821"); root.setProperty("--text","#d7e2f0"); root.setProperty("--muted","#8aa0b6"); root.setProperty("--border","#1f2a36");
        }
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aegis Protocol — Login</title>
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <style>
    :root { --bg:#0b0f14; --panel:#121821; --text:#d7e2f0; --muted:#8aa0b6; --border:#1f2a36; --accent:#2cc1ff; }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e131a);color:var(--text);font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{display:flex;align-items:center;gap:1rem;padding:1rem 1.5rem;border-bottom:1px solid var(--border);background:rgba(10,14,20,.85);position:sticky;top:0}
    .brand{display:flex;align-items:center;gap:.8rem}
    .motto{color:var(--muted);margin:0;font-size:.9rem}
    main{display:flex;flex-direction:column;gap:1rem;padding:1rem}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:1rem;max-width:760px;margin:0 auto}
    .row{display:flex;flex-direction:column;gap:.6rem}
    input,button{background:#0b121b;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:.6rem}
    button{cursor:pointer} button:hover{border-color:var(--accent);color:var(--accent)}
    video{width:100%;border:1px solid var(--border);border-radius:10px}
  </style>
  <script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
  <header>
    <div class="brand">
      <img src="assets/emblem.png" alt="Aegis Protocol Emblem" style="width:40px;height:40px;border-radius:8px;" />
      <div>
        <h1 style="margin:0;font-size:1.25rem;">Aegis Protocol</h1>
        <p class="motto">We see what others miss.</p>
      </div>
    </div>
  </header>

  <main>
    <div class="panel">
      <h2>Admin login</h2>
      <div class="row">
        <input id="adminCode" placeholder="Codename" value="admin" />
        <input id="adminPass" type="password" placeholder="Password" value="admin" />
        <button id="adminLogin">Login</button>
      </div>
      <p class="motto">Default admin is pre-seeded for first run.</p>
    </div>

    <div class="panel">
      <h2>Agent login (password + face)</h2>
      <div class="row">
        <input id="agentCode" placeholder="Codename" />
        <input id="agentPass" type="password" placeholder="Password" />
        <button id="agentLogin">Login + Face</button>
      </div>
      <div class="row" style="margin-top:.6rem;">
        <video id="loginVideo" autoplay playsinline></video>
        <span id="loginStatus" style="color:var(--muted)">Idle</span>
      </div>
    </div>
  </main>

  <script>
    function getDB(){ return JSON.parse(localStorage.getItem("aegis_db") || "{}"); }
    function setDB(db){ localStorage.setItem("aegis_db", JSON.stringify(db)); }
    function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h|=0 } return String(h); }
    (function seedAdmin(){ const db=getDB(); if (!db.admin){ db.admin={ codename:"admin", passHash:hash("admin"), role:"admin" }; db.agents=db.agents||{}; setDB(db);} })();

    const adminLoginBtn=document.getElementById("adminLogin");
    adminLoginBtn.addEventListener("click", ()=>{
      const db=getDB(); const admin=db.admin;
      const code=document.getElementById("adminCode").value.trim();
      const pass=document.getElementById("adminPass").value;
      if (admin && admin.codename===code && admin.passHash===hash(pass)) { location.href="admin.html"; }
      else { alert("Admin login failed"); }
    });

    const loginVideo=document.getElementById("loginVideo");
    async function startCam(){ try{ const s=await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); loginVideo.srcObject=s; }catch(e){ console.log("Camera error",e); } }
    startCam();

    let modelsLoaded=false;
    async function loadModels(){ const URL='https://unpkg.com/face-api.js@0.22.2/weights'; await faceapi.nets.tinyFaceDetector.loadFromUri(URL); await faceapi.nets.faceLandmark68Net.loadFromUri(URL); await faceapi.nets.faceRecognitionNet.loadFromUri(URL); modelsLoaded=true; }
    async function captureEmb(video){ if (!modelsLoaded) return null; const opts=new faceapi.TinyFaceDetectorOptions({ inputSize:256, scoreThreshold:0.5 }); const det=await faceapi.detectSingleFace(video,opts).withFaceLandmarks().withFaceDescriptor(); return det?.descriptor || null; }
    function match(a,b,t=0.6){ if(!a||!b||a.length!==b.length) return false; let sum=0; for(let i=0;i<a.length;i++){ const d=a[i]-b[i]; sum+=d*d; } return Math.sqrt(sum) < t; }

    document.getElementById("agentLogin").addEventListener("click", async ()=>{
      const code=document.getElementById("agentCode").value.trim();
      const pass=document.getElementById("agentPass").value;
      const db=getDB(); const agent=db.agents?.[code];
      const status=document.getElementById("loginStatus");
      if (!agent || agent.passHash!==hash(pass)){ status.textContent="Password invalid"; return; }
      status.textContent="Loading models…"; await loadModels();
      status.textContent="Scanning face…";
      const emb=await captureEmb(loginVideo);
      if (!emb){ status.textContent="No face detected"; return; }
      const ok=match(emb, Float32Array.from(agent.embedding));
      if (ok){ status.textContent="Access granted"; sessionStorage.setItem("aegis_session", code); location.href="dashboard.html"; }
      else { status.textContent="Face mismatch"; }
    });
  </script>
</body>
</html>
